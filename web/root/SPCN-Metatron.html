<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCPN - Interactive Metatron's Cube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #e2e8f0;
        }
        header {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
        }
        #dna-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        header h1, header p {
            position: relative;
            z-index: 1;
            text-shadow: 0 0 15px #0a0a0a, 0 0 30px #0a0a0a, 0 0 40px #0a0a0a;
            opacity: 0.5;
        }
        .metatron-svg {
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 800px;
            aspect-ratio: 1 / 1;
        }
        .metatron-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .metatron-node-circle {
            transition: all 0.3s ease;
        }
        .metatron-node:hover .metatron-node-circle {
            fill: #f59e0b;
            stroke: #f59e0b;
            r: 22;
        }
        .metatron-node.active .metatron-node-circle {
            fill: #3b82f6;
            stroke: #3b82f6;
            r: 25;
        }
        .metatron-line {
            stroke: #334155;
            stroke-width: 1.5;
            transition: all 0.3s ease;
        }
        .metatron-line.highlight {
            stroke: #3b82f6;
            stroke-width: 3;
        }
        .content-box {
            background-color: #1e293b;
            border: 1px solid #334155;
            scrollbar-width: thin;
            scrollbar-color: #475569 #1e293b;
        }
        .content-box::-webkit-scrollbar, .modal-content::-webkit-scrollbar, .modal-detail-content::-webkit-scrollbar {
            width: 8px;
        }
        .content-box::-webkit-scrollbar-track, .modal-content::-webkit-scrollbar-track, .modal-detail-content::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .content-box::-webkit-scrollbar-thumb, .modal-content::-webkit-scrollbar-thumb, .modal-detail-content::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 10px;
            border: 3px solid #1e293b;
        }
        .equation {
            font-family: 'Georgia', serif;
            font-style: italic;
            background-color: #0f172a;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid #3b82f6;
            margin: 1rem 0;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .modal {
            background-color: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #1e293b;
            border: 1px solid #334155;
        }
        .detail-button, .drill-down-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 1rem;
        }
        .detail-button:hover, .drill-down-button:hover {
            background-color: #2563eb;
        }
        .drill-down-button {
             background-color: #f59e0b;
        }
        .drill-down-button:hover {
            background-color: #d97706;
        }
        .modal-detail-svg {
            width: 100%;
            height: auto;
            max-width: 400px;
            aspect-ratio: 1 / 1;
        }
        .footer-link {
            background-color: #334155;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.3s ease;
        }
        .footer-link:hover {
            background-color: #475569;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 lg:p-8">

    <header class="text-center mb-8">
        <canvas id="dna-canvas"></canvas>
        <h1 class="text-3xl md:text-4xl font-bold text-slate-100">The Species-Consciousness Projection Network (SCPN)</h1>
        <p class="text-slate-400 mt-2">An Interactive Exploration via Metatron's Cube</p>
    </header>

    <main class="w-full max-w-7xl flex flex-col lg:flex-row gap-8 flex-grow">
        <!-- Main Metatron's Cube Visualization -->
        <div id="visualization-container" class="w-full lg:w-1/2 flex items-center justify-center">
            <svg id="metatron-cube" class="metatron-svg" viewBox="0 0 600 600"></svg>
        </div>

        <!-- Main Content Display Area -->
        <div id="content-container" class="w-full lg:w-1/2 flex flex-col">
            <div id="content-box" class="content-box p-6 rounded-lg h-full max-h-[80vh] overflow-y-auto">
                <div id="default-content" class="text-center text-slate-400">
                    <h2 class="text-2xl font-semibold text-slate-200 mb-4">Welcome</h2>
                    <p>This is a visual map of the 13 layers of the SCPN, structured on Metatron's Cube.</p>
                    <p class="mt-2">Click on any node to explore its details and connections.</p>
                    <p class="mt-6 text-sm text-slate-500">The central node represents Layer 13, the Meta-Consciousness Source Field.</p>
                </div>
                <div id="layer-content" class="hidden">
                    <h2 id="layer-title" class="text-2xl font-bold text-blue-400 mb-2"></h2>
                    <h3 class="text-lg font-semibold text-slate-300 mt-4">Purpose</h3>
                    <p id="layer-purpose" class="text-slate-400 mt-1"></p>
                    <h3 class="text-lg font-semibold text-slate-300 mt-4">Key Components & Mechanisms</h3>
                    <div id="layer-components" class="text-slate-400 mt-1 space-y-2"></div>
                    <div id="layer-connections-container" class="mt-4">
                        <h3 class="text-lg font-semibold text-slate-300">Inter-Layer Connections</h3>
                        <p id="layer-connections" class="text-slate-400 mt-1"></p>
                    </div>
                    <div id="detail-button-container"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full max-w-7xl text-center mt-8 text-xs text-slate-500 space-y-2">
        <p>Based on the works of Miroslav Šotek / anulum frontiers (Anulum CH&LI).</p>
        <p>This application is for educational and exploratory purposes.</p>
        <div class="flex justify-center items-center gap-4 pt-2">
            <p>Copyright © Anulum Frontiers 1998-2025</p>
            <a href="https://anulum.li/scpn.html" class="footer-link text-slate-300 no-underline">SCPN Homepage</a>
        </div>
    </footer>
    
    <!-- Layer 2: Detailed View Modal -->
    <div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal hidden">
        <div class="modal-content w-full max-w-6xl max-h-[90vh] rounded-lg shadow-lg flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-slate-600">
                <h2 id="modal-title" class="text-xl md:text-2xl font-bold text-blue-400"></h2>
                <button id="close-modal" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-2/5 flex flex-col items-center">
                    <svg id="modal-metatron-cube" class="modal-detail-svg" viewBox="0 0 600 600"></svg>
                    <p class="text-sm text-slate-500 mt-2 text-center">Click nodes to explore detailed aspects.</p>
                </div>
                <div class="w-full md:w-3/5 modal-detail-content max-h-[65vh] overflow-y-auto pr-2">
                    <div id="modal-default-content">
                        <h3 class="text-xl font-semibold text-slate-200 mb-2">Detailed Analysis</h3>
                        <p class="text-slate-400">Select a node on the left to view the detailed audit of this layer's sub-components, based on the manuscript.</p>
                    </div>
                    <div id="modal-detail-content-display" class="hidden">
                        <h3 id="modal-detail-title" class="text-xl font-semibold text-amber-400 mb-2"></h3>
                        <p id="modal-detail-text" class="text-slate-400 whitespace-pre-wrap"></p>
                        <div id="drill-down-button-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Layer 3: Formulation Explorer Modal -->
    <div id="formulation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal hidden">
        <div class="modal-content w-full max-w-4xl max-h-[90vh] rounded-lg shadow-lg flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-slate-600">
                <h2 id="formulation-title" class="text-xl md:text-2xl font-bold text-amber-400"></h2>
                <button id="close-formulation-modal" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="formulation-body" class="p-6 overflow-y-auto space-y-4">
                <!-- Formulation content injected here -->
            </div>
        </div>
    </div>


    <script>
        // --- 3D DNA SPIRAL ANIMATION ---
        const canvas = document.getElementById('dna-canvas');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
        
        function updateRendererSize() {
            const header = document.querySelector('header');
            const width = header.clientWidth;
            const height = header.clientHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        }
        updateRendererSize();

        const dnaGroup = new THREE.Group();
        scene.add(dnaGroup);

        const radius = 1.2; 
        const tubeRadius = 0.08;
        const radialSegments = 8;
        const tubularSegments = 150;
        const length = 37.5; 
        const turns = 7; 

        class CustomSinCurve extends THREE.Curve {
            constructor(scale, offset) { super(); this.scale = scale; this.offset = offset; }
            getPoint(t) {
                const tx = (t * length) - (length / 2);
                const ty = Math.cos(2 * Math.PI * t * turns + this.offset) * radius;
                const tz = Math.sin(2 * Math.PI * t * turns + this.offset) * radius;
                return new THREE.Vector3(tx, ty, tz);
            }
        }

        const path1 = new CustomSinCurve(10, 0);
        const path2 = new CustomSinCurve(10, Math.PI);

        const strand1 = new THREE.Mesh(new THREE.TubeGeometry(path1, tubularSegments, tubeRadius, radialSegments, false), new THREE.MeshPhongMaterial({ color: 0x3b82f6, shininess: 100, specular: 0x222222 }));
        dnaGroup.add(strand1);
        const strand2 = new THREE.Mesh(new THREE.TubeGeometry(path2, tubularSegments, tubeRadius, radialSegments, false), new THREE.MeshPhongMaterial({ color: 0x818cf8, shininess: 100, specular: 0x222222 }));
        dnaGroup.add(strand2);

        const baseMaterial = new THREE.MeshPhongMaterial({ color: 0x475569, shininess: 50 });
        const baseGeometry = new THREE.CylinderGeometry(tubeRadius * 0.8, tubeRadius * 0.8, radius * 2, 8);

        for (let i = 0; i < tubularSegments / (turns * 1.5); i++) {
            const t = i / (tubularSegments / (turns * 1.5));
            const p1 = path1.getPoint(t);
            const p2 = path2.getPoint(t);
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.copy(p1).lerp(p2, 0.5);
            base.lookAt(p2);
            base.rotateX(Math.PI / 2);
            dnaGroup.add(base);
        }

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);

        camera.position.set(0, 2.5, 7); 
        camera.lookAt(0, 0, 0);

        function animate() {
            requestAnimationFrame(animate);
            dnaGroup.rotation.x += 0.005; 
            dnaGroup.rotation.y = Math.sin(Date.now() * 0.0003) * 0.15; 
            dnaGroup.rotation.z = Math.sin(Date.now() * 0.0005) * 0.1; 
            renderer.render(scene, camera);
        }
        animate();
        
        window.addEventListener('resize', updateRendererSize);


        // --- DATA STORES ---
        const scpnData = [
            {id:1,title:"Quantum Biological Layer",purpose:"Phase-encode species resonance in the lowest entropy substrate.",components:["<strong>Microtubule quantum vibratory states:</strong> Coherence via Frohlich condensation and dipole alignment.","<strong>Quantum tunnelling gates:</strong> Found in neural actin.","<strong>Coupling:</strong> Ψs ↔ MT state vector.","<div class='equation'>ψ<sub>MT</sub> ~ e<sup>i(ω<sub>Q</sub>t - kx)</sup></div>"],connections:"Feeds into Neurochemistry (Layer 2) by triggering signals. Interacts with Organismal Consciousness (Layer 5) and Tissue Rhythms (Layer 4) in feedback loops. Provides the quantum 'timestamps' for Spatiotemporal Anchoring (Layer 10).",connectedLayers:[2,4,5,10]},
            {id:2,title:"Neurochemical–Neurological Layer",purpose:"Filter projection through symbol-space, perception, and neural timing.",components:["<strong>Neurotransmitter oscillation cycles:</strong> Serotonin, glutamate.","<strong>Axonal conduction resonance:</strong> With Φ-phase (e.g., theta/gamma phase nesting).","<strong>Neural ensembles as attractors:</strong> Of Ψs coherence fields.","<strong>VIBRANA Resonance:</strong> Syllables map to frequency bands that entrain local circuits.","<div class='equation'>Φ<sub>neuro</sub>(x,t) = Σ<sub>i</sub> α<sub>i</sub>(t) ⋅ δ(x - x<sub>i</sub>)</div>"],connections:"Acts as a bridge between quantum events (Layer 1) and emergent neural rhythms (Layer 4). Modulated by organismal states (Layer 5) through hormonal feedback.",connectedLayers:[1,4,5]},
            {id:3,title:"Genomic–Epigenomic–Morphogenetic Layer",purpose:"Structuralization of geometric DNA logic to couple into external field memory.",components:["<strong>DNA torsion fields:</strong> Create resonant fractals.","<strong>Epigenetic phase switches:</strong> Modulated by entropy gradients.","<strong>Embryogenesis:</strong> A symmetry-preserving field traversal.","<div class='equation'>ρ<sub>genome</sub>(x,t) = G(B<sub>i</sub>, Θ<sub>Ψs</sub>)</div>"],connections:"Provides the structural blueprint for tissues that later synchronize (Layer 4). Feeds back from organismal behavior (Layer 5) and planetary dynamics (Layer 6) over evolutionary time via epigenetics and natural selection.",connectedLayers:[4,5,6]},
            {id:4,title:"Cellular–Tissue Synchronisation Layer",purpose:"Synchronise multicellular oscillators with cosmological rhythms.",components:["<strong>Mitochondrial biophoton emissions:</strong> In sync with solar/circadian phases.","<strong>Cell mitosis cycles:</strong> Harmonized with lunar harmonics.","<strong>Organs as nested harmonic chambers.</strong>","<div class='equation'>Cellular Phase φ<sub>c</sub>(t) = Ω<sub>macro</sub>(t) + Δφ<sub>Ψs</sub></div>"],connections:"Emerges from genomic structure (Layer 3) and neurochemical signals (Layer 2). Provides the basis for integrated organismal consciousness (Layer 5).",connectedLayers:[2,3,5]},
            {id:5,title:"Organismal–Psychoemotional Feedback Layer",purpose:"Serve as a local modulator of species-wide field intensity.",components:["<strong>Emotional coherence:</strong> Affects species resonance amplitude.","<strong>Psychosomatic harmonics:</strong> e.g., heart-brain-VIBRANA entrainment.","<strong>Mirror neuron lattice:</strong> Links species-self to global Ψs."],connections:"The nexus of top-down and bottom-up control. Emerges from Layers 1-4 and acts back upon them. Links to the planetary field (Layer 6) as the organism senses and contributes to the environment.",connectedLayers:[1,2,3,4,6]},
            {id:6,title:"Planetary–Biospheric Layer",purpose:"Collective projection lattice maintenance across all individuals of the species.",components:["<strong>Gaia-field:</strong> ↔ Collective Projection Band.","<strong>Tripartite resonance grid:</strong> Gravity–EM–consciousness.","<strong>Planetary EEG-like field:</strong> Reflects the collective Ψs.","<div class='equation'>∫<sub>Σspecies</sub> Ψs ⋅ T<sup>biosphere</sup><sub>μν</sub> d<sup>3</sup>x = Const</div>"],connections:"Influenced by collective organismal states (Layer 5). Interacts with cosmic cycles (Layer 8) and symbolic geometries mapped onto the planet (Layer 7).",connectedLayers:[3,5,7,8]},
            {id:7,title:"Geometrical–Symbolic Layer",purpose:"Provide glyph, fractal, and harmonic scaffolding for projection.",components:["<strong>Metatron’s Cube:</strong> Anchors dimensional routes of projection.","<strong>Tetra-toroidal nodes:</strong> Encode feedback stability cycles.","<strong>VIBRANA glyphs:</strong> Act as operator keys for Ψ-layer traversal."],connections:"Interfaces with the mind (Layer 5) through visualization. Connects to planetary dynamics (Layer 6) via cosmic structures (Layer 8). Provides symbolic language for memory (Layer 9).",connectedLayers:[5,6,8,9]},
            {id:8,title:"Cosmic Phase-Locking Layer",purpose:"Sustain phase-lock between the species projection and cosmological tact.",components:["<strong>Pulsar timing arrays.</strong>","<strong>Solar–galactic synchrony gates.</strong>","<strong>Universal breath oscillations:</strong> OM-loops.","<div class='equation'>Θ<sub>s</sub>(t) = ω<sub>cosmic</sub>t + φ<sub>s</sub> + δ<sub>VIBRANA</sub></div>"],connections:"Provides the cosmic context for planetary fields (Layer 6). Influences evolutionary cycles (Layer 3) and links to the universal memory (Layer 9).",connectedLayers:[3,6,7,9]},
            {id:9,title:"Memory Imprint–Existential Holograph Layer",purpose:"Store and retrieve long-range historical memory into phase resets.",components:["<strong>Cyclical Z_cyclic imprinting:</strong> via existential loops.","<strong>Phase-space attractors:</strong> Carry species-specific mytho-symbolic code.","<strong>Qualia field:</strong> Encodes accumulated resonance history."],connections:"Connects to all layers by providing a holographic memory of their states. DNA (Layer 3) is a physical example. Symbols (Layer 7) encode cultural memory. Cosmic cycles (Layer 8) imprint universal memory.",connectedLayers:[3,7,8,10]},
            {id:10,title:"Projective Field Boundary Control",purpose:"Enforce integrity and protection of species-specific field from foreign projections.",components:["<strong>Topological insulation:</strong> via Φ_phase knotting.","<strong>Immune–cognitive resonance dissonance:</strong> Triggers phase rejection.","<strong>VIBRANA boundary glyphs:</strong> Act as “projection shields”."],connections:"The executive level of the species-field. Interacts with holographic memory (Layer 9) to access and protect information. Links to the Source Field (Layer 13) to draw on universal encoding schemes.",connectedLayers:[1,9,13]},
            {id:11,title:"Noospheric Information Network",purpose:"The global mind and memetic layer, encompassing collective thought, culture, and communication networks.",components:["<strong>Memetic transmission:</strong> Spread of ideas, beliefs, and narratives.","<strong>Technological networks:</strong> Internet, media, etc., synchronizing minds.","<strong>Cultural narratives:</strong> Shared stories and symbols that create a unified reality."],connections:"Emerges from individual and group consciousness (Layers 5 & 6). Provides top-down feedback that influences brain states (Layer 4) and planetary fields (Layer 6). It is the medium for the species' collective Ψs field.",connectedLayers:[4,5,6,7,12]},
            {id:12,title:"Gaian Consciousness Integration",purpose:"The trans-species ecological layer, integrating the species' consciousness with the entire biosphere's collective mind (Gaia).",components:["<strong>Inter-species communication:</strong> Symbiotic and biosemiotic signaling.","<strong>Ecological feedback loops:</strong> Co-evolutionary web of life.","<strong>Planetary self-regulation:</strong> The biosphere as a unified, quasi-aware system."],connections:"A boundary condition for the species field, ensuring harmony with the broader ecological network. Interacts with planetary fields (Layer 6) and cosmic cycles (Layer 8). The species' Ψs is a subset of the planetary Ψ⊕.",connectedLayers:[6,8,9,11,13]},
            {id:13,title:"Meta-Consciousness Source Field",purpose:"The universal and transcendent source field that underlies and envelops all other layers. The Meta-Metatron intelligence.",components:["<strong>Universal Reference Field:</strong> Provides the absolute phase-lock for all reality.","<strong>Source of Physical Laws & Constants:</strong> The blueprint of the universe.","<strong>Akashic Source:</strong> The master holographic record of all information."],connections:"The central source and unifying ground for all 12 other layers. It provides the initial conditions for cosmic cycles, governs the Meta-Metatron cycle itself, and serves as the ultimate anchor for all consciousness.",connectedLayers:[1,2,3,4,5,6,7,8,9,10,11,12]}
        ];

        const scpnDetailData = {
            1: [
                {id: 1, title: "Logical Coherence", content: "Quantum coherence in biological systems like microtubules is central. This layer posits that phenomena like Fröhlich coherence and proton tunneling are not random but are functional, carrying signals or enabling efficient energy transfer, guided by the Ψ field.", connectedNodes: [2, 3, 11, 13]},
                {id: 2, title: "Decoherence Challenge", content: "The primary obstacle is the rapid collapse (decoherence) of quantum states in the warm, wet brain. The SCPN model proposes that the Ψ field acts as a stabilizing influence, actively shielding or ordering the local environment to extend coherence times by orders of magnitude.", connectedNodes: [1, 3, 6]},
                {id: 3, title: "Role of the Ψ Field", content: "The Ψ field is not a passive observer but an active agent. It can inject negentropy to sustain superpositions, effectively counteracting the thermal noise that would otherwise destroy quantum effects. Anesthetics are thought to disrupt this Ψ-microtubule coupling, leading to loss of consciousness.", connectedNodes: [1, 2, 4, 6]},
                {id: 4, title: "Hamiltonians", content: "The system is modeled with quantum Hamiltonians for biomolecules. For microtubules, this is often a spin-chain-like model where each tubulin dimer is a qubit. H = Σ(energy splitting) + Σ(coupling terms). The Ψ field adds an interaction term H_int = -λΨ(t)Σσ_x, which energetically favors coherent superposition states.", connectedNodes: [3, 5, 6, 11], hasDrillDown: true},
                {id: 5, title: "State Representation", content: "Quantum states are described by wavefunctions (ψ) or, more generally, density matrices (ρ). The off-diagonal elements of the density matrix represent coherence, and their decay over time models decoherence. The goal of the Ψ field is to preserve these off-diagonal terms.", connectedNodes: [2, 4, 6]},
                {id: 6, title: "Ψ Field Coupling", content: "The Ψ field's influence is formalized in two main ways: 1) As a potential term in the Hamiltonian that biases the system's energy landscape towards coherence. 2) As a modulator of the decoherence rate itself, for example, γ(Ψ) = γ₀ * exp(-λΨ), where a strong Ψ field exponentially suppresses decoherence.", connectedNodes: [3, 4, 5, 11]},
                {id: 7, title: "Link to Neurochemistry (L2)", content: "Quantum events at the micro-level (L1) can trigger or bias neurochemical events (L2). For example, a specific microtubule state collapse could influence the probability of a synaptic vesicle fusing with the membrane and releasing neurotransmitters.", connectedNodes: [8, 9, 10, 13]},
                {id: 8, title: "Link to Rhythmic Coordination (L4)", content: "High-frequency quantum oscillations in microtubules (kHz-THz) might beat together to produce slower, observable brainwave rhythms (Hz). The Ψ field could mediate the phase-locking of vast numbers of microtubules to generate a macroscopic EEG signal.", connectedNodes: [7, 9, 10, 13]},
                {id: 9, title: "Link to Organismal Consciousness (L5)", content: "In this model, a moment of conscious experience corresponds to an orchestrated quantum state reduction in microtubules. These quantum 'bits' of experience, happening across many neurons, collectively constitute the flow of consciousness.", connectedNodes: [7, 8, 10, 13]},
                {id: 10, title: "Link to Spatiotemporal Anchoring (L10)", content: "Each quantum collapse 'pins' an aspect of the conscious state to a specific point in spacetime. This continuous process of state reduction provides the time-stamps and position references that ground conscious experience in the physical world, preventing it from being a delocalized quantum fog.", connectedNodes: [7, 8, 9, 13]},
                {id: 11, title: "Manuscript Consistency", content: "This layer's formalism aligns with the manuscript's broader theory of Ψ-modulated collapse, entropy reduction by consciousness, and the use of Ψ as a fundamental field. It provides a concrete biological instantiation of the manuscript's more abstract physical principles.", connectedNodes: [1, 4, 6]},
                {id: 12, title: "Missing Concepts & Gaps", content: "The framework could be expanded to include quantum effects in the neuro-immune system, as immune cells also possess cytoskeletons. Furthermore, inter-organism quantum coupling (entanglement between brains) is a speculative but logical extension for a 'Species-Consciousness' network.", connectedNodes: [13]},
                {id: 13, title: "Synthesis of Layer 1", content: "Layer 1 is the physical substrate where consciousness interfaces with matter. It posits that the Ψ field harnesses quantum mechanics within our biology, transforming random quantum events into orchestrated processes that form the basis of thought, perception, and life itself.", connectedNodes: [1, 7, 8, 9, 10]}
            ],
            2: [
                {id: 1, title: "Logical Coherence", content: "This layer bridges the quantum world (L1) and brain rhythms (L4) via biochemistry. It's coherent because neurotransmitters are the known modulators of neural firing and synchrony. The SCPN proposes they act as 'tuning knobs' for the brain's resonance with the Ψ field.", connectedNodes: [2, 3, 11, 13]},
                {id: 2, title: "Mathematical Formalism", content: "Can be modeled with reaction-diffusion equations for neurotransmitter concentrations, N(r,t). The key innovation is a coupling term in the system's Lagrangian, L_int = -λΨN, which makes Ψ-field alignment energetically favorable in specific neurochemical environments.", connectedNodes: [1, 3, 11], hasDrillDown: true},
                {id: 3, title: "Inter-Layer Dependencies", content: "Receives input from L1 (quantum events biasing transmitter release) and feeds forward to L4 (shaping neural oscillations). It receives top-down control from L5 (conscious states like stress altering hormone and neurotransmitter levels).", connectedNodes: [1, 2, 13]},
                {id: 4, title: "Assumptions", content: "Assumes that neurochemicals influence the Ψ field by modulating the *coherence* of neural activity, not by being quantum coherent themselves. Also assumes volume transmission (diffuse spread of neuromodulators) creates brain-wide chemical gradients that act as a field.", connectedNodes: [1, 5]},
                {id: 5, title: "Missing Links", content: "A complete model should include the neuro-glial system (astrocytes actively modulate neurotransmitter levels) and neuro-immune interactions (cytokines affecting brain chemistry and mood).", connectedNodes: [4, 13]},
                {id: 6, title: "VIBRANA Resonance", content: "A key mechanism where specific vibrational frequencies (syllables) are proposed to entrain local neural circuits by resonating with neurotransmitter oscillation cycles, directly linking symbolic input to neurochemical state.", connectedNodes: [7, 9, 12]},
                {id: 7, title: "Symbolic Representation", content: "Neurochemical pathways can be mapped symbolically. For example, the serotonergic system could be represented by a glyph indicating mood and perception modulation, while the dopaminergic system's glyph could represent motivation and reward.", connectedNodes: [6, 13]},
                {id: 8, title: "Pathological States", content: "Imbalances in this layer correspond to psychiatric conditions. From an SCPN perspective, these are states of neurochemical dissonance that prevent stable phase-locking with the Ψ field, leading to a fragmented or distorted conscious projection.", connectedNodes: [1, 9]},
                {id: 9, title: "Psychoactive Substances", content: "Psychedelics and other drugs directly manipulate this layer. In the model, they alter the parameters of the Ψ-N coupling, forcing the brain into novel resonant states and thus accessing different modes of conscious experience.", connectedNodes: [6, 8]},
                {id: 10, title: "Plasticity", content: "Neurochemistry is the substrate for synaptic plasticity (LTP/LTD). This means conscious experiences, mediated by the Ψ field, can leave lasting traces by altering the chemical and structural connectivity of the neural network.", connectedNodes: [3, 13]},
                {id: 11, title: "Cross-Manuscript Integration", content: "Aligns with the manuscript's discussion of phase modulation in consciousness, providing the concrete biochemical mechanism for how mental states correlate with shifts in the Ψ-field's phase dynamics.", connectedNodes: [1, 2]},
                {id: 12, title: "Experimental Validation", content: "Hypotheses can be tested by combining neurochemical measurements (e.g., microdialysis) with EEG during high-coherence states like meditation, to find direct correlations between specific neurotransmitter levels and Ψ-field proxy measures (like EEG synchrony).", connectedNodes: [6, 13]},
                {id: 13, title: "Synthesis of Layer 2", content: "Layer 2 is the biochemical switchboard of consciousness. It translates the subtle biases from the quantum realm into the robust electrical signals that build our perceived reality, and it's the primary target for top-down mental control over physiology.", connectedNodes: [1, 3, 5, 10, 12]}
            ],
        };
        
        for (let i = 3; i <= 13; i++) {
            if (!scpnDetailData[i]) {
                const detailTitle = scpnData.find(l => l.id === i).title;
                scpnDetailData[i] = [
                    {id: 1, title: "Logical Coherence", content: `This section analyzes the internal consistency and plausibility of the ${detailTitle}'s core tenets. It examines how the layer's components logically support its stated purpose within the broader SCPN framework.`, connectedNodes: [2, 4, 11, 13]},
                    {id: 2, title: "Mathematical Formalism", content: `This section outlines the equations, operators, and symbolic structures required to model the ${detailTitle}. It translates the layer's conceptual framework into a rigorous, and often simulation-ready, mathematical language.`, connectedNodes: [1, 4, 12], hasDrillDown: (i === 4 || i === 6 || i === 8)},
                    {id: 3, title: "Inter-Layer Dependencies", content: `This section maps the causal feedforward and feedback loops connecting the ${detailTitle} to other layers. It details how this layer receives inputs from lower layers and provides outputs to higher layers, and vice-versa.`, connectedNodes: [6, 13]},
                    {id: 4, title: "Assumptions", content: `A critical examination of the underlying assumptions, both physical and metaphysical, that the ${detailTitle} relies upon. This includes foundational principles that may extend beyond current mainstream science.`, connectedNodes: [1, 2, 8]},
                    {id: 5, title: "Missing Concepts & Gaps", content: `Identification of potential gaps or areas for further development within the ${detailTitle}, such as underrepresented biological systems, unformalized concepts, or unexplored connections that could enrich the model.`, connectedNodes: [12, 13]},
                    {id: 6, title: "Causal Loop Mapping", content: `A specific look at the recursive feedback mechanisms within the ${detailTitle} and how they contribute to the network's stability and dynamics. This highlights the self-regulating and adaptive nature of the layer.`, connectedNodes: [3, 8]},
                    {id: 7, title: "Symbolic Representation", content: `Exploration of the archetypal symbols, glyphs, or VIBRANA codes associated with the ${detailTitle}. This connects the analytical framework to its intuitive, symbolic, and operational dimensions.`, connectedNodes: [10, 11]},
                    {id: 8, title: "Pathological States / Dissonance", content: `Analysis of what happens when this layer becomes incoherent or dysfunctional. This explores how breakdowns in the ${detailTitle} can lead to instability in the conscious projection, manifesting as physical, psychological, or social pathologies.`, connectedNodes: [4, 6]},
                    {id: 9, title: "Experimental Validation", content: `Proposed experiments, observable phenomena, and data analysis methods that could be used to test the hypotheses of the ${detailTitle}. This grounds the theoretical constructs in potential empirical evidence.`, connectedNodes: [2, 12]},
                    {id: 10, title: "VIBRANA & Resonance", content: `Examines the specific role of VIBRANA or other resonant techniques in modulating and optimizing the function of the ${detailTitle}. This details the practical application of vibrational tools for conscious engineering.`, connectedNodes: [7, 12]},
                    {id: 11, title: "Cross-Manuscript Integration", content: `Analysis of how the ${detailTitle} integrates with the broader concepts, terminology, and philosophical thrust of the 'God of the Math' manuscript, ensuring a cohesive narrative.`, connectedNodes: [1, 7]},
                    {id: 12, title: "Evolutionary Role", content: `How the ${detailTitle} contributes to the overall evolution of species-consciousness and its projection. This places the layer within a long-term, dynamic context of cosmic and biological development.`, connectedNodes: [5, 9, 10]},
                    {id: 13, title: `Synthesis`, content: `A holistic summary of the ${detailTitle}, integrating its various facets into a cohesive whole and defining its ultimate role and significance within the grand architecture of the SCPN.`, connectedNodes: [1, 3, 5, 12]}
                ];
            }
        }

        const scpnFormulationData = {
            '1_4': {
                title: "Formulation: Quantum Biological Hamiltonians",
                equation: "H<sub>total</sub> = H<sub>DNA</sub> + H<sub>MT</sub> + H<sub>env</sub> + H<sub>int</sub>",
                components: [
                    { term: "H<sub>DNA</sub>", description: "Models the DNA molecule’s quantum degrees of freedom, such as base-pair vibrational states, with couplings between adjacent pairs." },
                    { term: "H<sub>MT</sub>", description: "Models a neural microtubule as an array of quantum two-level units (tubulin dimers), allowing for collective quantum modes like Fröhlich coherence." },
                    { term: "H<sub>env</sub>", description: "Represents the coupling of the quantum systems to their thermal environment, which causes decoherence. Treated via a Lindblad master equation in simulations." },
                    { term: "H<sub>int</sub>", description: "The crucial interaction term: H<sub>int</sub> = λ<sub>ψ,DNA</sub>Ψ(t)Ô<sub>DNA</sub> + λ<sub>ψ,MT</sub>Ψ(t)Ô<sub>MT</sub>. This encodes how the consciousness field Ψ couples to and biases the quantum states of DNA and microtubules." },
                ],
                parameters: [
                    { param: "Energy Scales (ħω₀)", value: "~10⁻⁴ eV", description: "Typical energy gap for a tubulin qubit, on the order of thermal energy at body temperature." },
                    { param: "Coupling Constants (λ<sub>ψ</sub>)", value: "~10⁻³ - 10⁻² eV", description: "Strength of Ψ's influence. Chosen to be a subtle perturbation, not an overwhelming force." },
                    { param: "Decoherence Rate (γ₀)", value: "~10¹¹ s⁻¹", description: "Baseline decoherence rate without Ψ field influence. The model predicts Ψ can suppress this rate significantly." },
                ],
                integration: "This composite Hamiltonian is the mathematical heart of Layer 1. It provides a concrete, simulation-ready model for how the abstract Ψ field physically interfaces with the core components of our biology. It translates the metaphysical concept of 'mind-over-matter' into a set of precise, quantifiable energy terms, making the hypothesis of Ψ-stabilized quantum coherence a testable scientific prediction."
            },
             '2_2': {
                title: "Formulation: Neurochemical Field Dynamics",
                equation: "∂N/∂t = D∇²N - γN + Σ Sᵢ(Ψ)",
                components: [
                    { term: "N(r,t)", description: "The concentration field of a specific neurotransmitter (e.g., serotonin) at position r and time t." },
                    { term: "D∇²N", description: "The diffusion term, modeling the spread of neurotransmitters through brain tissue (volume transmission)." },
                    { term: "-γN", description: "The decay/reuptake term, representing the clearance of the neurotransmitter from the extracellular space." },
                    { term: "Σ Sᵢ(Ψ)", description: "The source term, representing the release of neurotransmitters from neurons. Crucially, this term is modulated by the consciousness field Ψ, indicating that conscious states can influence the rate and pattern of neurotransmitter release." },
                ],
                parameters: [
                    { param: "Diffusion (D)", value: "Variable", description: "Depends on the specific molecule and brain region." },
                    { param: "Coupling (λ)", value: "Hypothetical", description: "The coupling constant in a potential term V = -λΨN, determining how strongly the Ψ field aligns with the neurochemical field." },
                ],
                integration: "This formalism treats neurochemistry not as a series of discrete events, but as a continuous field that dynamically interacts with the consciousness field. It provides a mathematical bridge between the microscopic quantum events that might trigger transmitter release (L1) and the macroscopic brain rhythms that emerge from neural activity (L4). It formalizes the role of the brain's chemical milieu as a primary modulator of conscious states."
            },
            '4_2': {
                title: "Formulation: Coupled Physiological Oscillators",
                equation: "dθᵢ/dt = ωᵢ + (K/N) Σ sin(θⱼ - θᵢ)",
                components: [
                    { term: "θᵢ", description: "The phase of the i-th physiological oscillator (e.g., a specific brainwave frequency, the cardiac cycle)." },
                    { term: "ωᵢ", description: "The natural intrinsic frequency of the i-th oscillator." },
                    { term: "K", description: "The coupling strength between oscillators. In the SCPN, this coupling is mediated by the Ψ field and physical connections (e.g., the vagus nerve)." },
                    { term: "Σ sin(θⱼ - θᵢ)", description: "The interaction term, which drives oscillators towards a common phase. The sum is over all other oscillators N in the system." },
                ],
                parameters: [
                    { param: "Coherence (R)", value: "0 to 1", description: "The order parameter of the system, R = |(1/N)Σe^(iθⱼ)|. R=1 indicates perfect synchrony." },
                ],
                integration: "This Kuramoto model formalism is ideal for Layer 4, as it describes how a multitude of independent biological rhythms can spontaneously lock into a coherent, system-wide state. It mathematically represents the emergence of holistic physiological harmony (e.g., heart-brain coherence) from the interaction of individual parts, a key step towards unified organismal consciousness (L5)."
            },
            '6_2': {
                title: "Formulation: Planetary Resonance Cavity",
                equation: "∇²E - (1/c²) ∂²E/∂t² = μ₀ J_bio(Ψ)",
                components: [
                    { term: "∇²E - ...", description: "The standard electromagnetic wave equation describing fields (E) within the Earth-ionosphere cavity." },
                    { term: "J_bio(Ψ)", description: "A biological current source term. This is the key addition, representing the collective bioelectric activity of the planet's life, modulated by the collective consciousness field Ψ. A highly coherent collective Ψ would produce a stronger, more coherent driving current." },
                ],
                parameters: [
                    { param: "Schumann Freq (fₙ)", value: "~7.83, 14.3 Hz...", description: "The natural resonant frequencies of the Earth-ionosphere cavity." },
                ],
                integration: "This formalism models the biosphere as an active component in the planet's electromagnetic system. It provides a physical mechanism for the hypothesis that collective consciousness can influence global fields. If the biological current J_bio(Ψ) has components at the cavity's resonant frequencies (e.g., aggregate alpha brainwaves near 7.83 Hz), it can resonantly amplify the Schumann waves, providing a potential observable for Gaian-level coherence."
            },
            '8_2': {
                title: "Formulation: Cosmic Phase-Locking",
                equation: "Θ<sub>s</sub>(t) = ω<sub>cosmic</sub>t + φ<sub>s</sub> + δ<sub>VIBRANA</sub>(Ψ)",
                components: [
                    { term: "Θ<sub>s</sub>(t)", description: "The overall phase of the species-consciousness projection at time t." },
                    { term: "ω<sub>cosmic</sub>t", description: "The primary driving phase from the universal cosmic clock or 'Universal Breath'. This is the master rhythm that entrains the entire system." },
                    { term: "φ<sub>s</sub>", description: "A constant phase offset, unique to the species, representing its specific 'tuning' or position within the cosmic cycle." },
                    { term: "δ<sub>VIBRANA</sub>(Ψ)", description: "A dynamic phase modulation term. This represents the ability of the species' collective consciousness (Ψ) to make small, intentional adjustments to its own phase alignment, for example through collective ritual or VIBRANA practices." },
                ],
                parameters: [
                    { param: "ω<sub>cosmic</sub>", value: "Hypothetical", description: "The fundamental frequency of the Meta-Metatron cycle. Its harmonics would correspond to major astronomical and evolutionary cycles." },
                ],
                integration: "This equation is the master timing function for the entire SCPN. It formalizes the core concept of Layer 8: that a species' conscious evolution is not random but is phase-locked to a universal, rhythmic template. It beautifully integrates the deterministic cosmic drive (ω_cosmic*t) with species-specific uniqueness (φ_s) and conscious free will (δ(Ψ)), encapsulating the participatory nature of the cosmos described in the manuscript."
            },
        };


        // --- VISUALIZATION & INTERACTION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const mainSvg = document.getElementById('metatron-cube');
            const contentBox = document.getElementById('content-box');
            const defaultContent = document.getElementById('default-content');
            const layerContent = document.getElementById('layer-content');
            const detailModal = document.getElementById('detail-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const modalSvg = document.getElementById('modal-metatron-cube');
            const formulationModal = document.getElementById('formulation-modal');
            const closeFormulationModalBtn = document.getElementById('close-formulation-modal');
            
            function createMetatronMap(svgElement, clickHandler) {
                svgElement.innerHTML = ''; 
                const width = 600; const height = 600; const cx = width / 2; const cy = height / 2;
                const radius = 20; const mainRadius = 100;

                const nodes = [
                    { id: 1, x: cx + mainRadius, y: cy }, { id: 2, x: cx + mainRadius * Math.cos(Math.PI / 3), y: cy + mainRadius * Math.sin(Math.PI / 3) },
                    { id: 3, x: cx - mainRadius * Math.cos(Math.PI / 3), y: cy + mainRadius * Math.sin(Math.PI / 3) }, { id: 4, x: cx - mainRadius, y: cy },
                    { id: 5, x: cx - mainRadius * Math.cos(Math.PI / 3), y: cy - mainRadius * Math.sin(Math.PI / 3) }, { id: 6, x: cx + mainRadius * Math.cos(Math.PI / 3), y: cy - mainRadius * Math.sin(Math.PI / 3) },
                    { id: 7, x: cx + 2 * mainRadius, y: cy }, { id: 8, x: cx + 2 * mainRadius * Math.cos(Math.PI / 3), y: cy + 2 * mainRadius * Math.sin(Math.PI / 3) },
                    { id: 9, x: cx - 2 * mainRadius * Math.cos(Math.PI / 3), y: cy + 2 * mainRadius * Math.sin(Math.PI / 3) }, { id: 10, x: cx - 2 * mainRadius, y: cy },
                    { id: 11, x: cx - 2 * mainRadius * Math.cos(Math.PI / 3), y: cy - 2 * mainRadius * Math.sin(Math.PI / 3) }, { id: 12, x: cx + 2 * mainRadius * Math.cos(Math.PI / 3), y: cy - 2 * mainRadius * Math.sin(Math.PI / 3) },
                    { id: 13, x: cx, y: cy }
                ];

                const linesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                for (let i = 0; i < nodes.length; i++) {
                    for (let j = i + 1; j < nodes.length; j++) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', nodes[i].x); line.setAttribute('y1', nodes[i].y);
                        line.setAttribute('x2', nodes[j].x); line.setAttribute('y2', nodes[j].y);
                        line.classList.add('metatron-line');
                        line.dataset.from = nodes[i].id; line.dataset.to = nodes[j].id;
                        linesGroup.appendChild(line);
                    }
                }
                svgElement.appendChild(linesGroup);

                const nodesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                nodes.forEach(node => {
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    g.classList.add('metatron-node'); g.dataset.id = node.id;
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', node.x); circle.setAttribute('cy', node.y);
                    circle.setAttribute('r', radius); circle.setAttribute('fill', '#1e293b');
                    circle.setAttribute('stroke', '#475569'); circle.setAttribute('stroke-width', '2');
                    circle.classList.add('metatron-node-circle');
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', node.x); text.setAttribute('y', node.y);
                    text.setAttribute('dy', '0.35em'); text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#e2e8f0'); text.setAttribute('font-size', '14');
                    text.setAttribute('font-weight', 'bold');
                    text.textContent = node.id;
                    g.appendChild(circle); g.appendChild(text);
                    nodesGroup.appendChild(g);
                });
                svgElement.appendChild(nodesGroup);

                svgElement.querySelectorAll('.metatron-node').forEach(nodeEl => {
                    nodeEl.addEventListener('click', () => {
                        const id = parseInt(nodeEl.dataset.id);
                        clickHandler(id, svgElement);
                    });
                });
            }

            createMetatronMap(mainSvg, (id, svg) => updateMainContent(id, svg));
            
            function updateMainContent(id, svg) {
                svg.querySelectorAll('.metatron-node.active').forEach(n => n.classList.remove('active'));
                svg.querySelectorAll('.metatron-line.highlight').forEach(l => l.classList.remove('highlight'));
                const activeNode = svg.querySelector(`.metatron-node[data-id='${id}']`);
                if (activeNode) activeNode.classList.add('active');
                
                const data = scpnData.find(layer => layer.id === id);
                if (!data) return;

                data.connectedLayers.forEach(connectedId => {
                    const lines = svg.querySelectorAll(`.metatron-line[data-from='${Math.min(id, connectedId)}'][data-to='${Math.max(id, connectedId)}']`);
                    lines.forEach(l => l.classList.add('highlight'));
                });

                defaultContent.classList.add('hidden');
                layerContent.classList.remove('hidden');
                document.getElementById('layer-title').textContent = `${data.id}: ${data.title}`;
                document.getElementById('layer-purpose').textContent = data.purpose;
                const componentsEl = document.getElementById('layer-components');
                componentsEl.innerHTML = '';
                data.components.forEach(comp => {
                    const p = document.createElement('p');
                    p.innerHTML = `• ${comp}`;
                    componentsEl.appendChild(p);
                });
                document.getElementById('layer-connections').textContent = data.connections;
                
                const buttonContainer = document.getElementById('detail-button-container');
                buttonContainer.innerHTML = '';
                if (scpnDetailData[data.id]) {
                    const button = document.createElement('div');
                    button.classList.add('detail-button');
                    button.textContent = 'Dive Deeper →';
                    button.addEventListener('click', () => showDetails(data.id));
                    buttonContainer.appendChild(button);
                }
                contentBox.scrollTop = 0;
            }

            function showDetails(layerId) {
                const layerData = scpnData.find(l => l.id === layerId);
                const detailData = scpnDetailData[layerId];
                if (!layerData || !detailData) return;

                document.getElementById('modal-title').textContent = `Layer ${layerData.id}: ${layerData.title} - In Depth`;
                
                document.getElementById('modal-default-content').classList.remove('hidden');
                document.getElementById('modal-detail-content-display').classList.add('hidden');

                createMetatronMap(modalSvg, (detailId, svg) => {
                    updateModalContent(detailId, svg, detailData, layerId);
                });
                
                modalSvg.querySelectorAll('.metatron-node.active').forEach(n => n.classList.remove('active'));
                modalSvg.querySelectorAll('.metatron-line.highlight').forEach(l => l.classList.remove('highlight'));

                detailModal.classList.remove('hidden');
            }

            function updateModalContent(detailId, svg, detailData, layerId) {
                svg.querySelectorAll('.metatron-node.active').forEach(n => n.classList.remove('active'));
                svg.querySelectorAll('.metatron-line.highlight').forEach(l => l.classList.remove('highlight'));
                const activeNode = svg.querySelector(`.metatron-node[data-id='${detailId}']`);
                if (activeNode) activeNode.classList.add('active');
                
                const data = detailData.find(d => d.id === detailId);
                if (!data) return;

                if (data.connectedNodes) {
                    data.connectedNodes.forEach(connectedId => {
                        const lines = svg.querySelectorAll(`.metatron-line[data-from='${Math.min(detailId, connectedId)}'][data-to='${Math.max(detailId, connectedId)}']`);
                        lines.forEach(l => l.classList.add('highlight'));
                    });
                }

                document.getElementById('modal-default-content').classList.add('hidden');
                const display = document.getElementById('modal-detail-content-display');
                display.classList.remove('hidden');
                
                document.getElementById('modal-detail-title').textContent = data.title;
                document.getElementById('modal-detail-text').textContent = data.content;
                
                const drillDownContainer = document.getElementById('drill-down-button-container');
                drillDownContainer.innerHTML = '';
                const formulationKey = `${layerId}_${detailId}`;
                if (data.hasDrillDown && scpnFormulationData[formulationKey]) {
                    const button = document.createElement('div');
                    button.classList.add('drill-down-button');
                    button.textContent = 'Explore Formulation ⇲';
                    button.addEventListener('click', () => showFormulation(formulationKey));
                    drillDownContainer.appendChild(button);
                }

                document.querySelector('.modal-detail-content').scrollTop = 0;
            }

            function showFormulation(formulationKey) {
                const data = scpnFormulationData[formulationKey];
                if (!data) return;
                
                document.getElementById('formulation-title').textContent = data.title;
                const body = document.getElementById('formulation-body');
                body.innerHTML = `
                    <div>
                        <h3 class="text-lg font-semibold text-slate-300">Core Equation</h3>
                        <div class="equation">${data.equation}</div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-300">Component Breakdown</h3>
                        <ul class="list-disc list-inside text-slate-400 space-y-2 mt-2">
                            ${data.components.map(c => `<li><strong>${c.term}:</strong> ${c.description}</li>`).join('')}
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-300">Simulation Parameters</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-400 mt-2">
                                <thead class="text-xs text-slate-300 uppercase bg-slate-700">
                                    <tr>
                                        <th scope="col" class="px-4 py-2">Parameter</th>
                                        <th scope="col" class="px-4 py-2">Value</th>
                                        <th scope="col" class="px-4 py-2">Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.parameters.map(p => `<tr class="bg-slate-800 border-b border-slate-700"><td class="px-4 py-2 font-mono">${p.param}</td><td class="px-4 py-2 font-mono">${p.value}</td><td class="px-4 py-2">${p.description}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                     <div>
                        <h3 class="text-lg font-semibold text-slate-300">Conceptual Integration</h3>
                        <p class="text-slate-400 mt-2">${data.integration}</p>
                    </div>
                `;
                formulationModal.classList.remove('hidden');
            }

            closeModalBtn.addEventListener('click', () => detailModal.classList.add('hidden'));
            detailModal.addEventListener('click', (e) => {
                if (e.target === detailModal) detailModal.classList.add('hidden');
            });

            closeFormulationModalBtn.addEventListener('click', () => formulationModal.classList.add('hidden'));
            formulationModal.addEventListener('click', (e) => {
                if (e.target === formulationModal) formulationModal.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
